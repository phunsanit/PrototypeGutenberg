{"version":3,"sources":["@wordpress/format-library/src/link/inline.js"],"names":["uniqueId","useMemo","useState","__","withSpokenMessages","Popover","prependHTTP","create","insert","isCollapsed","applyFormat","__experimentalLinkControl","LinkControl","createLinkFormat","isValidHref","InlineLinkUI","isActive","activeAttributes","addingLink","value","onChange","speak","stopAddingLink","mountingKey","nextLinkValue","setNextLinkValue","anchorRef","selection","window","getSelection","rangeCount","range","getRangeAt","element","startContainer","nextElementSibling","nodeType","Node","ELEMENT_NODE","parentNode","closest","start","end","linkValue","url","type","id","opensInNewTab","target","onChangeLink","nextValue","didToggleSetting","didToggleSettingForNewLink","undefined","newUrl","format","String","opensInNewWindow","newText","title","toInsert","text","length","newValue","activeFormats"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { uniqueId } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { useMemo, useState } from '@wordpress/element';\nimport { __ } from '@wordpress/i18n';\nimport { withSpokenMessages, Popover } from '@wordpress/components';\nimport { prependHTTP } from '@wordpress/url';\nimport { create, insert, isCollapsed, applyFormat } from '@wordpress/rich-text';\nimport { __experimentalLinkControl as LinkControl } from '@wordpress/block-editor';\n\n/**\n * Internal dependencies\n */\nimport { createLinkFormat, isValidHref } from './utils';\n\nfunction InlineLinkUI( {\n\tisActive,\n\tactiveAttributes,\n\taddingLink,\n\tvalue,\n\tonChange,\n\tspeak,\n\tstopAddingLink,\n} ) {\n\t/**\n\t * A unique key is generated when switching between editing and not editing\n\t * a link, based on:\n\t *\n\t * - This component may be rendered _either_ when a link is active _or_\n\t *   when adding or editing a link.\n\t * - It's only desirable to shift focus into the Popover when explicitly\n\t *   adding or editing a link, not when in the inline boundary of a link.\n\t * - Focus behavior can only be controlled on a Popover at the time it\n\t *   mounts, so a new instance of the component must be mounted to\n\t *   programmatically enact the focusOnMount behavior.\n\t *\n\t * @type {string}\n\t */\n\tconst mountingKey = useMemo( uniqueId, [ addingLink ] );\n\n\t/**\n\t * Pending settings to be applied to the next link. When inserting a new\n\t * link, toggle values cannot be applied immediately, because there is not\n\t * yet a link for them to apply to. Thus, they are maintained in a state\n\t * value until the time that the link can be inserted or edited.\n\t *\n\t * @type {[Object|undefined,Function]}\n\t */\n\tconst [ nextLinkValue, setNextLinkValue ] = useState();\n\n\tconst anchorRef = useMemo( () => {\n\t\tconst selection = window.getSelection();\n\n\t\tif ( ! selection.rangeCount ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst range = selection.getRangeAt( 0 );\n\n\t\tif ( addingLink && ! isActive ) {\n\t\t\treturn range;\n\t\t}\n\n\t\tlet element = range.startContainer;\n\n\t\t// If the caret is right before the element, select the next element.\n\t\telement = element.nextElementSibling || element;\n\n\t\twhile ( element.nodeType !== window.Node.ELEMENT_NODE ) {\n\t\t\telement = element.parentNode;\n\t\t}\n\n\t\treturn element.closest( 'a' );\n\t}, [ addingLink, value.start, value.end ] );\n\n\tconst linkValue = {\n\t\turl: activeAttributes.url,\n\t\ttype: activeAttributes.type,\n\t\tid: activeAttributes.id,\n\t\topensInNewTab: activeAttributes.target === '_blank',\n\t\t...nextLinkValue,\n\t};\n\n\tfunction onChangeLink( nextValue ) {\n\t\t// Merge with values from state, both for the purpose of assigning the\n\t\t// next state value, and for use in constructing the new link format if\n\t\t// the link is ready to be applied.\n\t\tnextValue = {\n\t\t\t...nextLinkValue,\n\t\t\t...nextValue,\n\t\t};\n\n\t\t// LinkControl calls `onChange` immediately upon the toggling a setting.\n\t\tconst didToggleSetting =\n\t\t\tlinkValue.opensInNewTab !== nextValue.opensInNewTab &&\n\t\t\tlinkValue.url === nextValue.url;\n\n\t\t// If change handler was called as a result of a settings change during\n\t\t// link insertion, it must be held in state until the link is ready to\n\t\t// be applied.\n\t\tconst didToggleSettingForNewLink =\n\t\t\tdidToggleSetting && nextValue.url === undefined;\n\n\t\t// If link will be assigned, the state value can be considered flushed.\n\t\t// Otherwise, persist the pending changes.\n\t\tsetNextLinkValue( didToggleSettingForNewLink ? nextValue : undefined );\n\n\t\tif ( didToggleSettingForNewLink ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst newUrl = prependHTTP( nextValue.url );\n\t\tconst format = createLinkFormat( {\n\t\t\turl: newUrl,\n\t\t\ttype: nextValue.type,\n\t\t\tid:\n\t\t\t\tnextValue.id !== undefined && nextValue.id !== null\n\t\t\t\t\t? String( nextValue.id )\n\t\t\t\t\t: undefined,\n\t\t\topensInNewWindow: nextValue.opensInNewTab,\n\t\t} );\n\n\t\tif ( isCollapsed( value ) && ! isActive ) {\n\t\t\tconst newText = nextValue.title || newUrl;\n\t\t\tconst toInsert = applyFormat(\n\t\t\t\tcreate( { text: newText } ),\n\t\t\t\tformat,\n\t\t\t\t0,\n\t\t\t\tnewText.length\n\t\t\t);\n\t\t\tonChange( insert( value, toInsert ) );\n\t\t} else {\n\t\t\tconst newValue = applyFormat( value, format );\n\t\t\tnewValue.start = newValue.end;\n\t\t\tnewValue.activeFormats = [];\n\t\t\tonChange( newValue );\n\t\t}\n\n\t\t// Focus should only be shifted back to the formatted segment when the\n\t\t// URL is submitted.\n\t\tif ( ! didToggleSetting ) {\n\t\t\tstopAddingLink();\n\t\t}\n\n\t\tif ( ! isValidHref( newUrl ) ) {\n\t\t\tspeak(\n\t\t\t\t__(\n\t\t\t\t\t'Warning: the link has been inserted but may have errors. Please test it.'\n\t\t\t\t),\n\t\t\t\t'assertive'\n\t\t\t);\n\t\t} else if ( isActive ) {\n\t\t\tspeak( __( 'Link edited.' ), 'assertive' );\n\t\t} else {\n\t\t\tspeak( __( 'Link inserted.' ), 'assertive' );\n\t\t}\n\t}\n\n\treturn (\n\t\t<Popover\n\t\t\tkey={ mountingKey }\n\t\t\tanchorRef={ anchorRef }\n\t\t\tfocusOnMount={ addingLink ? 'firstElement' : false }\n\t\t\tonClose={ stopAddingLink }\n\t\t\tposition=\"bottom center\"\n\t\t>\n\t\t\t<LinkControl\n\t\t\t\tvalue={ linkValue }\n\t\t\t\tonChange={ onChangeLink }\n\t\t\t\tforceIsEditingLink={ addingLink }\n\t\t\t/>\n\t\t</Popover>\n\t);\n}\n\nexport default withSpokenMessages( InlineLinkUI );\n"]}