{"version":3,"sources":["@wordpress/edit-navigation/src/components/menu-editor/use-navigation-blocks.js"],"names":["groupBy","isEqual","difference","createBlock","useSelect","useDispatch","useState","useRef","useEffect","__","createBlockFromMenuItem","menuItem","innerBlocks","label","title","rendered","url","createMenuItemAttributesFromBlock","block","attributes","useNavigationBlocks","menuId","menuItems","select","getMenuItems","menus","per_page","saveMenuItem","createSuccessNotice","blocks","setBlocks","menuItemsRef","itemsByParentID","current","createMenuItemBlocks","items","item","menuItemInnerBlocks","id","length","clientId","push","saveBlocks","parentItemId","parent","saveNestedBlocks","nestedBlocks","parentId","currentItemId","savedItem","deletedClientIds","Object","keys","map","deletedClientId","type"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { groupBy, isEqual, difference } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { createBlock } from '@wordpress/blocks';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { useState, useRef, useEffect } from '@wordpress/element';\nimport { __ } from '@wordpress/i18n';\n\nfunction createBlockFromMenuItem( menuItem, innerBlocks = [] ) {\n\treturn createBlock(\n\t\t'core/navigation-link',\n\t\t{\n\t\t\tlabel: menuItem.title.rendered,\n\t\t\turl: menuItem.url,\n\t\t},\n\t\tinnerBlocks\n\t);\n}\n\nfunction createMenuItemAttributesFromBlock( block ) {\n\treturn {\n\t\ttitle: block.attributes.label,\n\t\turl: block.attributes.url,\n\t};\n}\n\nexport default function useNavigationBlocks( menuId ) {\n\t// menuItems is an array of menu item objects.\n\tconst menuItems = useSelect(\n\t\t( select ) =>\n\t\t\tselect( 'core' ).getMenuItems( { menus: menuId, per_page: -1 } ),\n\t\t[ menuId ]\n\t);\n\n\tconst { saveMenuItem } = useDispatch( 'core' );\n\tconst { createSuccessNotice } = useDispatch( 'core/notices' );\n\tconst [ blocks, setBlocks ] = useState( [] );\n\n\tconst menuItemsRef = useRef( {} );\n\n\tuseEffect( () => {\n\t\tif ( ! menuItems ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst itemsByParentID = groupBy( menuItems, 'parent' );\n\n\t\tmenuItemsRef.current = {};\n\n\t\tconst createMenuItemBlocks = ( items ) => {\n\t\t\tconst innerBlocks = [];\n\t\t\tif ( ! items ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tfor ( const item of items ) {\n\t\t\t\tlet menuItemInnerBlocks = [];\n\t\t\t\tif ( itemsByParentID[ item.id ]?.length ) {\n\t\t\t\t\tmenuItemInnerBlocks = createMenuItemBlocks(\n\t\t\t\t\t\titemsByParentID[ item.id ]\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tconst block = createBlockFromMenuItem(\n\t\t\t\t\titem,\n\t\t\t\t\tmenuItemInnerBlocks\n\t\t\t\t);\n\t\t\t\tmenuItemsRef.current[ block.clientId ] = item;\n\t\t\t\tinnerBlocks.push( block );\n\t\t\t}\n\t\t\treturn innerBlocks;\n\t\t};\n\n\t\t// createMenuItemBlocks takes an array of top-level menu items and recursively creates all their innerBlocks\n\t\tconst innerBlocks = createMenuItemBlocks( itemsByParentID[ 0 ] );\n\t\tsetBlocks( [ createBlock( 'core/navigation', {}, innerBlocks ) ] );\n\t}, [ menuItems ] );\n\n\tconst saveBlocks = () => {\n\t\tconst { clientId, innerBlocks } = blocks[ 0 ];\n\t\tconst parentItemId = menuItemsRef.current[ clientId ]?.parent;\n\n\t\tconst saveNestedBlocks = async ( nestedBlocks, parentId = 0 ) => {\n\t\t\tfor ( const block of nestedBlocks ) {\n\t\t\t\tconst menuItem = menuItemsRef.current[ block.clientId ];\n\t\t\t\tlet currentItemId = menuItem?.id || 0;\n\n\t\t\t\tif ( ! menuItem ) {\n\t\t\t\t\tconst savedItem = await saveMenuItem( {\n\t\t\t\t\t\t...createMenuItemAttributesFromBlock( block ),\n\t\t\t\t\t\tmenus: menuId,\n\t\t\t\t\t\tparent: parentId,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( block.innerBlocks.length ) {\n\t\t\t\t\t\tcurrentItemId = savedItem.id;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\tmenuItem &&\n\t\t\t\t\t! isEqual(\n\t\t\t\t\t\tblock.attributes,\n\t\t\t\t\t\tcreateBlockFromMenuItem( menuItem ).attributes\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tsaveMenuItem( {\n\t\t\t\t\t\t...menuItem,\n\t\t\t\t\t\t...createMenuItemAttributesFromBlock( block ),\n\t\t\t\t\t\tmenus: menuId, // Gotta do this because REST API doesn't like receiving an array here. Maybe a bug in the REST API?\n\t\t\t\t\t\tparent: parentId,\n\t\t\t\t\t} );\n\t\t\t\t}\n\n\t\t\t\tif ( block.innerBlocks.length ) {\n\t\t\t\t\tsaveNestedBlocks( block.innerBlocks, currentItemId );\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tsaveNestedBlocks( innerBlocks, parentItemId );\n\n\t\tconst deletedClientIds = difference(\n\t\t\tObject.keys( menuItemsRef.current ),\n\t\t\tinnerBlocks.map( ( block ) => block.clientId )\n\t\t);\n\n\t\t// Disable reason, this code will eventually be implemented.\n\t\t// eslint-disable-next-line no-unused-vars\n\t\tfor ( const deletedClientId of deletedClientIds ) {\n\t\t\t// TODO - delete menu items.\n\t\t}\n\n\t\tcreateSuccessNotice( __( 'Navigation saved.' ), {\n\t\t\ttype: 'snackbar',\n\t\t} );\n\t};\n\n\treturn [ blocks, setBlocks, saveBlocks ];\n}\n"]}