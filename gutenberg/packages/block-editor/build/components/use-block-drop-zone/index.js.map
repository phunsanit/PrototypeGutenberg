{"version":3,"sources":["@wordpress/block-editor/src/components/use-block-drop-zone/index.js"],"names":["parseDropEvent","event","result","srcRootClientId","srcClientId","srcIndex","type","dataTransfer","Object","assign","JSON","parse","getData","err","useBlockDropZone","element","rootClientId","clientId","setClientId","selector","select","getBlockIndex","getClientIdsOfDescendants","getSettings","getTemplateLock","blockIndex","hasUploadPermissions","mediaUpload","isLockedAll","insertBlocks","updateBlockAttributes","moveBlockToPosition","onFilesDrop","files","transformation","transform","isMatch","blocks","onHTMLDrop","HTML","mode","length","onDrop","isBlockDropType","dropType","isSameLevel","srcRoot","dstRoot","isSameBlock","src","dst","isSrcBlockAnAncestorOfDstBlock","some","id","dstIndex","undefined","positionIndex","insertIndex","isDisabled","withPosition","position","y","rect","current","getBoundingClientRect","offset","top","target","Array","from","children","find","blockEl","offsetTop","offsetHeight","targetClientId","slice"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { __unstableUseDropZone as useDropZone } from '@wordpress/components';\nimport {\n\tpasteHandler,\n\tgetBlockTransforms,\n\tfindTransform,\n} from '@wordpress/blocks';\nimport { useDispatch, useSelect } from '@wordpress/data';\nimport { useEffect, useState, useCallback } from '@wordpress/element';\n\nconst parseDropEvent = ( event ) => {\n\tlet result = {\n\t\tsrcRootClientId: null,\n\t\tsrcClientId: null,\n\t\tsrcIndex: null,\n\t\ttype: null,\n\t};\n\n\tif ( ! event.dataTransfer ) {\n\t\treturn result;\n\t}\n\n\ttry {\n\t\tresult = Object.assign(\n\t\t\tresult,\n\t\t\tJSON.parse( event.dataTransfer.getData( 'text' ) )\n\t\t);\n\t} catch ( err ) {\n\t\treturn result;\n\t}\n\n\treturn result;\n};\n\nexport default function useBlockDropZone( { element, rootClientId } ) {\n\tconst [ clientId, setClientId ] = useState( null );\n\n\tfunction selector( select ) {\n\t\tconst {\n\t\t\tgetBlockIndex,\n\t\t\tgetClientIdsOfDescendants,\n\t\t\tgetSettings,\n\t\t\tgetTemplateLock,\n\t\t} = select( 'core/block-editor' );\n\t\treturn {\n\t\t\tgetBlockIndex,\n\t\t\tblockIndex: getBlockIndex( clientId, rootClientId ),\n\t\t\tgetClientIdsOfDescendants,\n\t\t\thasUploadPermissions: !! getSettings().mediaUpload,\n\t\t\tisLockedAll: getTemplateLock( rootClientId ) === 'all',\n\t\t};\n\t}\n\n\tconst {\n\t\tgetBlockIndex,\n\t\tblockIndex,\n\t\tgetClientIdsOfDescendants,\n\t\thasUploadPermissions,\n\t\tisLockedAll,\n\t} = useSelect( selector, [ rootClientId, clientId ] );\n\tconst {\n\t\tinsertBlocks,\n\t\tupdateBlockAttributes,\n\t\tmoveBlockToPosition,\n\t} = useDispatch( 'core/block-editor' );\n\n\tconst onFilesDrop = useCallback(\n\t\t( files ) => {\n\t\t\tif ( ! hasUploadPermissions ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst transformation = findTransform(\n\t\t\t\tgetBlockTransforms( 'from' ),\n\t\t\t\t( transform ) =>\n\t\t\t\t\ttransform.type === 'files' && transform.isMatch( files )\n\t\t\t);\n\n\t\t\tif ( transformation ) {\n\t\t\t\tconst blocks = transformation.transform(\n\t\t\t\t\tfiles,\n\t\t\t\t\tupdateBlockAttributes\n\t\t\t\t);\n\t\t\t\tinsertBlocks( blocks, blockIndex, rootClientId );\n\t\t\t}\n\t\t},\n\t\t[\n\t\t\thasUploadPermissions,\n\t\t\tupdateBlockAttributes,\n\t\t\tinsertBlocks,\n\t\t\tblockIndex,\n\t\t\trootClientId,\n\t\t]\n\t);\n\n\tconst onHTMLDrop = useCallback(\n\t\t( HTML ) => {\n\t\t\tconst blocks = pasteHandler( { HTML, mode: 'BLOCKS' } );\n\n\t\t\tif ( blocks.length ) {\n\t\t\t\tinsertBlocks( blocks, blockIndex, rootClientId );\n\t\t\t}\n\t\t},\n\t\t[ insertBlocks, blockIndex, rootClientId ]\n\t);\n\n\tconst onDrop = useCallback(\n\t\t( event ) => {\n\t\t\tconst {\n\t\t\t\tsrcRootClientId,\n\t\t\t\tsrcClientId,\n\t\t\t\tsrcIndex,\n\t\t\t\ttype,\n\t\t\t} = parseDropEvent( event );\n\n\t\t\tconst isBlockDropType = ( dropType ) => dropType === 'block';\n\t\t\tconst isSameLevel = ( srcRoot, dstRoot ) => {\n\t\t\t\t// Note that rootClientId of top-level blocks will be undefined OR a void string,\n\t\t\t\t// so we also need to account for that case separately.\n\t\t\t\treturn (\n\t\t\t\t\tsrcRoot === dstRoot ||\n\t\t\t\t\t( ! srcRoot === true && ! dstRoot === true )\n\t\t\t\t);\n\t\t\t};\n\t\t\tconst isSameBlock = ( src, dst ) => src === dst;\n\t\t\tconst isSrcBlockAnAncestorOfDstBlock = ( src, dst ) =>\n\t\t\t\tgetClientIdsOfDescendants( [ src ] ).some(\n\t\t\t\t\t( id ) => id === dst\n\t\t\t\t);\n\n\t\t\tif (\n\t\t\t\t! isBlockDropType( type ) ||\n\t\t\t\tisSameBlock( srcClientId, clientId ) ||\n\t\t\t\tisSrcBlockAnAncestorOfDstBlock(\n\t\t\t\t\tsrcClientId,\n\t\t\t\t\tclientId || rootClientId\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst dstIndex = clientId\n\t\t\t\t? getBlockIndex( clientId, rootClientId )\n\t\t\t\t: undefined;\n\t\t\tconst positionIndex = blockIndex;\n\t\t\t// If the block is kept at the same level and moved downwards,\n\t\t\t// subtract to account for blocks shifting upward to occupy its old position.\n\t\t\tconst insertIndex =\n\t\t\t\tdstIndex &&\n\t\t\t\tsrcIndex < dstIndex &&\n\t\t\t\tisSameLevel( srcRootClientId, rootClientId )\n\t\t\t\t\t? positionIndex - 1\n\t\t\t\t\t: positionIndex;\n\t\t\tmoveBlockToPosition(\n\t\t\t\tsrcClientId,\n\t\t\t\tsrcRootClientId,\n\t\t\t\trootClientId,\n\t\t\t\tinsertIndex\n\t\t\t);\n\t\t},\n\t\t[\n\t\t\tgetClientIdsOfDescendants,\n\t\t\tgetBlockIndex,\n\t\t\tclientId,\n\t\t\tblockIndex,\n\t\t\tmoveBlockToPosition,\n\t\t\trootClientId,\n\t\t]\n\t);\n\n\tconst { position } = useDropZone( {\n\t\telement,\n\t\tonFilesDrop,\n\t\tonHTMLDrop,\n\t\tonDrop,\n\t\tisDisabled: isLockedAll,\n\t\twithPosition: true,\n\t} );\n\n\tuseEffect( () => {\n\t\tif ( position ) {\n\t\t\tconst { y } = position;\n\t\t\tconst rect = element.current.getBoundingClientRect();\n\n\t\t\tconst offset = y - rect.top;\n\t\t\tconst target = Array.from( element.current.children ).find(\n\t\t\t\t( blockEl ) => {\n\t\t\t\t\treturn (\n\t\t\t\t\t\tblockEl.offsetTop + blockEl.offsetHeight / 2 > offset\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tif ( ! target ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst targetClientId = target.id.slice( 'block-'.length );\n\n\t\t\tif ( ! targetClientId ) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsetClientId( targetClientId );\n\t\t}\n\t}, [ position ] );\n\n\tif ( position ) {\n\t\treturn clientId;\n\t}\n}\n"]}