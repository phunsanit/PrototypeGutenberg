{"version":3,"sources":["@wordpress/block-library/src/gallery/gallery-image.js"],"names":["classnames","debounce","Component","Button","Spinner","__","BACKSPACE","DELETE","withSelect","withDispatch","RichText","isBlobURL","compose","close","chevronLeft","chevronRight","GalleryImage","arguments","onBlur","bind","onFocus","onSelectImage","onSelectCaption","onRemoveImage","bindContainer","debouncedOnDeselect","props","onDeselect","state","captionSelected","ref","container","setState","isSelected","onSelect","event","document","activeElement","indexOf","keyCode","stopPropagation","preventDefault","onRemove","prevProps","image","url","__unstableMarkNextChangeAsNotPersistent","setAttributes","source_url","alt","alt_text","cancel","id","linkTo","link","isFirstItem","isLastItem","caption","onMoveForward","onMoveBackward","ariaLabel","href","img","className","undefined","newCaption","select","ownProps","getMedia","parseInt","dispatch"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport classnames from 'classnames';\nimport { debounce } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport { Button, Spinner } from '@wordpress/components';\nimport { __ } from '@wordpress/i18n';\nimport { BACKSPACE, DELETE } from '@wordpress/keycodes';\nimport { withSelect, withDispatch } from '@wordpress/data';\nimport { RichText } from '@wordpress/block-editor';\nimport { isBlobURL } from '@wordpress/blob';\nimport { compose } from '@wordpress/compose';\nimport { close, chevronLeft, chevronRight } from '@wordpress/icons';\n\nclass GalleryImage extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.onBlur = this.onBlur.bind( this );\n\t\tthis.onFocus = this.onFocus.bind( this );\n\t\tthis.onSelectImage = this.onSelectImage.bind( this );\n\t\tthis.onSelectCaption = this.onSelectCaption.bind( this );\n\t\tthis.onRemoveImage = this.onRemoveImage.bind( this );\n\t\tthis.bindContainer = this.bindContainer.bind( this );\n\n\t\t// The onDeselect prop is used to signal that the GalleryImage component\n\t\t// has lost focus. We want to call it when focus has been lost\n\t\t// by the figure element or any of its children but only if\n\t\t// the element that gained focus isn't any of them.\n\t\t//\n\t\t// debouncedOnSelect is scheduled every time a figure's children\n\t\t// is blurred and cancelled when any is focused. If none gain focus,\n\t\t// the call to onDeselect will be executed.\n\t\t//\n\t\t// onBlur / onFocus events are quick operations (<5ms apart in my testing),\n\t\t// so 50ms accounts for 10x lagging while feels responsive to the user.\n\t\tthis.debouncedOnDeselect = debounce( this.props.onDeselect, 50 );\n\n\t\tthis.state = {\n\t\t\tcaptionSelected: false,\n\t\t};\n\t}\n\n\tbindContainer( ref ) {\n\t\tthis.container = ref;\n\t}\n\n\tonSelectCaption() {\n\t\tif ( ! this.state.captionSelected ) {\n\t\t\tthis.setState( {\n\t\t\t\tcaptionSelected: true,\n\t\t\t} );\n\t\t}\n\n\t\tif ( ! this.props.isSelected ) {\n\t\t\tthis.props.onSelect();\n\t\t}\n\t}\n\n\tonSelectImage() {\n\t\tif ( ! this.props.isSelected ) {\n\t\t\tthis.props.onSelect();\n\t\t}\n\n\t\tif ( this.state.captionSelected ) {\n\t\t\tthis.setState( {\n\t\t\t\tcaptionSelected: false,\n\t\t\t} );\n\t\t}\n\t}\n\n\tonRemoveImage( event ) {\n\t\tif (\n\t\t\tthis.container === document.activeElement &&\n\t\t\tthis.props.isSelected &&\n\t\t\t[ BACKSPACE, DELETE ].indexOf( event.keyCode ) !== -1\n\t\t) {\n\t\t\tevent.stopPropagation();\n\t\t\tevent.preventDefault();\n\t\t\tthis.props.onRemove();\n\t\t}\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tconst {\n\t\t\tisSelected,\n\t\t\timage,\n\t\t\turl,\n\t\t\t__unstableMarkNextChangeAsNotPersistent,\n\t\t} = this.props;\n\t\tif ( image && ! url ) {\n\t\t\t__unstableMarkNextChangeAsNotPersistent();\n\t\t\tthis.props.setAttributes( {\n\t\t\t\turl: image.source_url,\n\t\t\t\talt: image.alt_text,\n\t\t\t} );\n\t\t}\n\n\t\t// unselect the caption so when the user selects other image and comeback\n\t\t// the caption is not immediately selected\n\t\tif (\n\t\t\tthis.state.captionSelected &&\n\t\t\t! isSelected &&\n\t\t\tprevProps.isSelected\n\t\t) {\n\t\t\tthis.setState( {\n\t\t\t\tcaptionSelected: false,\n\t\t\t} );\n\t\t}\n\t}\n\n\t/**\n\t * Note that, unlike the DOM, all React events bubble,\n\t * so this will be called after the onBlur event of any figure's children.\n\t */\n\tonBlur() {\n\t\tthis.debouncedOnDeselect();\n\t}\n\n\t/**\n\t * Note that, unlike the DOM, all React events bubble,\n\t * so this will be called after the onBlur event of any figure's children.\n\t */\n\tonFocus() {\n\t\tthis.debouncedOnDeselect.cancel();\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\turl,\n\t\t\talt,\n\t\t\tid,\n\t\t\tlinkTo,\n\t\t\tlink,\n\t\t\tisFirstItem,\n\t\t\tisLastItem,\n\t\t\tisSelected,\n\t\t\tcaption,\n\t\t\tonRemove,\n\t\t\tonMoveForward,\n\t\t\tonMoveBackward,\n\t\t\tsetAttributes,\n\t\t\t'aria-label': ariaLabel,\n\t\t} = this.props;\n\n\t\tlet href;\n\n\t\tswitch ( linkTo ) {\n\t\t\tcase 'media':\n\t\t\t\thref = url;\n\t\t\t\tbreak;\n\t\t\tcase 'attachment':\n\t\t\t\thref = link;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tconst img = (\n\t\t\t// Disable reason: Image itself is not meant to be interactive, but should\n\t\t\t// direct image selection and unfocus caption fields.\n\t\t\t/* eslint-disable jsx-a11y/no-noninteractive-element-interactions */\n\t\t\t<>\n\t\t\t\t<img\n\t\t\t\t\tsrc={ url }\n\t\t\t\t\talt={ alt }\n\t\t\t\t\tdata-id={ id }\n\t\t\t\t\tonClick={ this.onSelectImage }\n\t\t\t\t\tonFocus={ this.onSelectImage }\n\t\t\t\t\tonKeyDown={ this.onRemoveImage }\n\t\t\t\t\ttabIndex=\"0\"\n\t\t\t\t\taria-label={ ariaLabel }\n\t\t\t\t\tref={ this.bindContainer }\n\t\t\t\t/>\n\t\t\t\t{ isBlobURL( url ) && <Spinner /> }\n\t\t\t</>\n\t\t\t/* eslint-enable jsx-a11y/no-noninteractive-element-interactions */\n\t\t);\n\n\t\tconst className = classnames( {\n\t\t\t'is-selected': isSelected,\n\t\t\t'is-transient': isBlobURL( url ),\n\t\t} );\n\n\t\treturn (\n\t\t\t<figure\n\t\t\t\tclassName={ className }\n\t\t\t\tonBlur={ this.onBlur }\n\t\t\t\tonFocus={ this.onFocus }\n\t\t\t>\n\t\t\t\t{ href ? <a href={ href }>{ img }</a> : img }\n\t\t\t\t<div className=\"block-library-gallery-item__move-menu\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\ticon={ chevronLeft }\n\t\t\t\t\t\tonClick={ isFirstItem ? undefined : onMoveBackward }\n\t\t\t\t\t\tclassName=\"blocks-gallery-item__move-backward\"\n\t\t\t\t\t\tlabel={ __( 'Move image backward' ) }\n\t\t\t\t\t\taria-disabled={ isFirstItem }\n\t\t\t\t\t\tdisabled={ ! isSelected }\n\t\t\t\t\t/>\n\t\t\t\t\t<Button\n\t\t\t\t\t\ticon={ chevronRight }\n\t\t\t\t\t\tonClick={ isLastItem ? undefined : onMoveForward }\n\t\t\t\t\t\tclassName=\"blocks-gallery-item__move-forward\"\n\t\t\t\t\t\tlabel={ __( 'Move image forward' ) }\n\t\t\t\t\t\taria-disabled={ isLastItem }\n\t\t\t\t\t\tdisabled={ ! isSelected }\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"block-library-gallery-item__inline-menu\">\n\t\t\t\t\t<Button\n\t\t\t\t\t\ticon={ close }\n\t\t\t\t\t\tonClick={ onRemove }\n\t\t\t\t\t\tclassName=\"blocks-gallery-item__remove\"\n\t\t\t\t\t\tlabel={ __( 'Remove image' ) }\n\t\t\t\t\t\tdisabled={ ! isSelected }\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t{ ( isSelected || caption ) && (\n\t\t\t\t\t<RichText\n\t\t\t\t\t\ttagName=\"figcaption\"\n\t\t\t\t\t\tplaceholder={\n\t\t\t\t\t\t\tisSelected ? __( 'Write caption…' ) : null\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvalue={ caption }\n\t\t\t\t\t\tisSelected={ this.state.captionSelected }\n\t\t\t\t\t\tonChange={ ( newCaption ) =>\n\t\t\t\t\t\t\tsetAttributes( { caption: newCaption } )\n\t\t\t\t\t\t}\n\t\t\t\t\t\tunstableOnFocus={ this.onSelectCaption }\n\t\t\t\t\t\tinlineToolbar\n\t\t\t\t\t/>\n\t\t\t\t) }\n\t\t\t</figure>\n\t\t);\n\t}\n}\n\nexport default compose( [\n\twithSelect( ( select, ownProps ) => {\n\t\tconst { getMedia } = select( 'core' );\n\t\tconst { id } = ownProps;\n\n\t\treturn {\n\t\t\timage: id ? getMedia( parseInt( id, 10 ) ) : null,\n\t\t};\n\t} ),\n\twithDispatch( ( dispatch ) => {\n\t\tconst { __unstableMarkNextChangeAsNotPersistent } = dispatch(\n\t\t\t'core/block-editor'\n\t\t);\n\t\treturn {\n\t\t\t__unstableMarkNextChangeAsNotPersistent,\n\t\t};\n\t} ),\n] )( GalleryImage );\n"]}