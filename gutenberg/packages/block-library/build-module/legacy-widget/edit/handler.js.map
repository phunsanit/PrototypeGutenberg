{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/handler.js"],"names":["get","Component","apiFetch","withInstanceId","LegacyWidgetEditDomManager","window","XMLHttpRequest","FormData","LegacyWidgetEditHandler","arguments","state","form","widgetNonce","instanceUpdating","onInstanceChange","bind","requestWidgetUpdater","isStillMounted","trySetNonce","undefined","response","props","prevProps","instance","instanceId","id","number","idBase","isSelected","widgetName","widgetTitle","title","display","isVisible","ref","widgetEditDomManagerRef","element","document","getElementById","value","instanceChanges","callback","widgetClass","httpRequest","formData","append","open","ajaxurl","addEventListener","responseText","setState","send","path","data","instance_changes","method","then"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { get } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component } from '@wordpress/element';\nimport apiFetch from '@wordpress/api-fetch';\nimport { withInstanceId } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport LegacyWidgetEditDomManager from './dom-manager';\n\nconst { XMLHttpRequest, FormData } = window;\n\nclass LegacyWidgetEditHandler extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\t\tthis.state = {\n\t\t\tform: null,\n\t\t};\n\t\tthis.widgetNonce = null;\n\t\tthis.instanceUpdating = null;\n\t\tthis.onInstanceChange = this.onInstanceChange.bind( this );\n\t\tthis.requestWidgetUpdater = this.requestWidgetUpdater.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.isStillMounted = true;\n\t\tthis.trySetNonce();\n\t\tthis.requestWidgetUpdater( undefined, ( response ) => {\n\t\t\tthis.props.onInstanceChange( null, !! response.form );\n\t\t} );\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tif ( ! this.widgetNonce ) {\n\t\t\tthis.trySetNonce();\n\t\t}\n\t\tif (\n\t\t\tprevProps.instance !== this.props.instance &&\n\t\t\tthis.instanceUpdating !== this.props.instance\n\t\t) {\n\t\t\tthis.requestWidgetUpdater( undefined, ( response ) => {\n\t\t\t\tthis.props.onInstanceChange( null, !! response.form );\n\t\t\t} );\n\t\t}\n\t\tif ( this.instanceUpdating === this.props.instance ) {\n\t\t\tthis.instanceUpdating = null;\n\t\t}\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.isStillMounted = false;\n\t}\n\n\trender() {\n\t\tconst {\n\t\t\tinstanceId,\n\t\t\tid,\n\t\t\tnumber,\n\t\t\tidBase,\n\t\t\tinstance,\n\t\t\tisSelected,\n\t\t\twidgetName,\n\t\t} = this.props;\n\t\tconst { form } = this.state;\n\n\t\tif ( ! form ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst widgetTitle = get( instance, [ 'title' ] );\n\t\tlet title = null;\n\t\tif ( isSelected ) {\n\t\t\tif ( widgetTitle && widgetName ) {\n\t\t\t\ttitle = `${ widgetName }: ${ widgetTitle }`;\n\t\t\t} else if ( ! widgetTitle && widgetName ) {\n\t\t\t\ttitle = widgetName;\n\t\t\t} else if ( widgetTitle && ! widgetName ) {\n\t\t\t\ttitle = widgetTitle;\n\t\t\t}\n\t\t}\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{ title && (\n\t\t\t\t\t<div className=\"wp-block-legacy-widget__edit-widget-title\">\n\t\t\t\t\t\t{ title }\n\t\t\t\t\t</div>\n\t\t\t\t) }\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"wp-block-legacy-widget__edit-container\"\n\t\t\t\t\t// Display none is used because when we switch from edit to preview,\n\t\t\t\t\t// we don't want to unmount the component.\n\t\t\t\t\t// Otherwise when we went back to edit we wound need to trigger\n\t\t\t\t\t// all widgets events again and some scripts may not deal well with this.\n\t\t\t\t\tstyle={ {\n\t\t\t\t\t\tdisplay: this.props.isVisible ? 'block' : 'none',\n\t\t\t\t\t} }\n\t\t\t\t>\n\t\t\t\t\t<LegacyWidgetEditDomManager\n\t\t\t\t\t\tisReferenceWidget={ !! id }\n\t\t\t\t\t\tref={ ( ref ) => {\n\t\t\t\t\t\t\tthis.widgetEditDomManagerRef = ref;\n\t\t\t\t\t\t} }\n\t\t\t\t\t\tonInstanceChange={ this.onInstanceChange }\n\t\t\t\t\t\tnumber={ number ? number : instanceId * -1 }\n\t\t\t\t\t\tid={ id }\n\t\t\t\t\t\tidBase={ idBase }\n\t\t\t\t\t\tform={ form }\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</>\n\t\t);\n\t}\n\n\ttrySetNonce() {\n\t\tconst element = document.getElementById( '_wpnonce_widgets' );\n\t\tif ( element && element.value ) {\n\t\t\tthis.widgetNonce = element.value;\n\t\t}\n\t}\n\n\tonInstanceChange( instanceChanges ) {\n\t\tconst { id } = this.props;\n\t\tif ( id ) {\n\t\t\t// For reference widgets there is no need to query an endpoint,\n\t\t\t// the widget is already saved with ajax.\n\t\t\tthis.props.onInstanceChange( instanceChanges, true );\n\t\t\treturn;\n\t\t}\n\t\tthis.requestWidgetUpdater( instanceChanges, ( response ) => {\n\t\t\tthis.instanceUpdating = response.instance;\n\t\t\tthis.props.onInstanceChange( response.instance, !! response.form );\n\t\t} );\n\t}\n\n\trequestWidgetUpdater( instanceChanges, callback ) {\n\t\tconst { id, idBase, instance, widgetClass } = this.props;\n\t\tconst { isStillMounted } = this;\n\t\tif ( ! id && ! widgetClass ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// If we are in the presence of a reference widget, do a save ajax request\n\t\t// with empty changes so we retrieve the widget edit form.\n\t\tif ( id ) {\n\t\t\tconst httpRequest = new XMLHttpRequest();\n\t\t\tconst formData = new FormData();\n\t\t\tformData.append( 'action', 'save-widget' );\n\t\t\tformData.append( 'id_base', idBase );\n\t\t\tformData.append( 'widget-id', id );\n\t\t\tformData.append( 'widget-width', '250' );\n\t\t\tformData.append( 'widget-height', '200' );\n\t\t\tformData.append( 'savewidgets', this.widgetNonce );\n\t\t\thttpRequest.open( 'POST', window.ajaxurl );\n\t\t\thttpRequest.addEventListener( 'load', () => {\n\t\t\t\tif ( isStillMounted ) {\n\t\t\t\t\tconst form = httpRequest.responseText;\n\t\t\t\t\tthis.setState( { form } );\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tcallback( { form } );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\t\t\thttpRequest.send( formData );\n\t\t\treturn;\n\t\t}\n\n\t\tif ( widgetClass ) {\n\t\t\tapiFetch( {\n\t\t\t\tpath: `/__experimental/widget-forms/${ widgetClass }/`,\n\t\t\t\tdata: {\n\t\t\t\t\tinstance,\n\t\t\t\t\tinstance_changes: instanceChanges,\n\t\t\t\t},\n\t\t\t\tmethod: 'POST',\n\t\t\t} ).then( ( response ) => {\n\t\t\t\tif ( isStillMounted ) {\n\t\t\t\t\tthis.setState( {\n\t\t\t\t\t\tform: response.form,\n\t\t\t\t\t} );\n\t\t\t\t\tif ( callback ) {\n\t\t\t\t\t\tcallback( response );\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} );\n\t\t}\n\t}\n}\n\nexport default withInstanceId( LegacyWidgetEditHandler );\n"]}