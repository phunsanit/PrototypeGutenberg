{"version":3,"sources":["@wordpress/block-library/src/legacy-widget/edit/dom-manager.js"],"names":["LegacyWidgetEditDomManager","arguments","containerRef","formRef","widgetContentRef","idBaseInputRef","widgetNumberInputRef","triggerWidgetEvent","bind","previousFormData","window","FormData","current","nextProps","shouldTriggerWidgetUpdateEvent","idBase","props","value","number","form","widgetContent","innerHTML","id","isReferenceWidget","shouldTriggerInstanceUpdate","wpWidgets","save","jQuery","onInstanceChange","retrieveUpdatedInstance","__html","currentFormData","currentFormDataKeys","Array","from","keys","previousFormDataKeys","length","rawKey","getAll","event","document","trigger","formData","updatedInstance","matches","match","keyParsed","Component"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport { includes } from 'lodash';\n\n/**\n * WordPress dependencies\n */\nimport { Component, createRef } from '@wordpress/element';\nimport isShallowEqual from '@wordpress/is-shallow-equal';\n\nclass LegacyWidgetEditDomManager extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.containerRef = createRef();\n\t\tthis.formRef = createRef();\n\t\tthis.widgetContentRef = createRef();\n\t\tthis.idBaseInputRef = createRef();\n\t\tthis.widgetNumberInputRef = createRef();\n\t\tthis.triggerWidgetEvent = this.triggerWidgetEvent.bind( this );\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.triggerWidgetEvent( 'widget-added' );\n\t\tthis.previousFormData = new window.FormData( this.formRef.current );\n\t}\n\n\tshouldComponentUpdate( nextProps ) {\n\t\tlet shouldTriggerWidgetUpdateEvent = false;\n\t\t// We can not leverage react render otherwise we would destroy dom changes applied by the plugins.\n\t\t// We manually update the required dom node replicating what the widget screen and the customizer do.\n\t\tif (\n\t\t\tnextProps.idBase !== this.props.idBase &&\n\t\t\tthis.idBaseInputRef.current\n\t\t) {\n\t\t\tthis.idBaseInputRef.current.value = nextProps.idBase;\n\t\t\tshouldTriggerWidgetUpdateEvent = true;\n\t\t}\n\t\tif (\n\t\t\tnextProps.number !== this.props.number &&\n\t\t\tthis.widgetNumberInputRef.current\n\t\t) {\n\t\t\tthis.widgetNumberInputRef.current.value = nextProps.number;\n\t\t}\n\t\tif (\n\t\t\tnextProps.form !== this.props.form &&\n\t\t\tthis.widgetContentRef.current\n\t\t) {\n\t\t\tconst widgetContent = this.widgetContentRef.current;\n\t\t\twidgetContent.innerHTML = nextProps.form;\n\t\t\tshouldTriggerWidgetUpdateEvent = true;\n\t\t}\n\t\tif ( shouldTriggerWidgetUpdateEvent ) {\n\t\t\tthis.triggerWidgetEvent( 'widget-updated' );\n\t\t\tthis.previousFormData = new window.FormData( this.formRef.current );\n\t\t}\n\t\treturn false;\n\t}\n\n\trender() {\n\t\tconst { id, idBase, number, form, isReferenceWidget } = this.props;\n\t\treturn (\n\t\t\t<div className=\"widget open\" ref={ this.containerRef }>\n\t\t\t\t<div className=\"widget-inside\">\n\t\t\t\t\t<form\n\t\t\t\t\t\tclassName=\"form\"\n\t\t\t\t\t\tref={ this.formRef }\n\t\t\t\t\t\tmethod=\"post\"\n\t\t\t\t\t\tonBlur={ () => {\n\t\t\t\t\t\t\tif ( this.shouldTriggerInstanceUpdate() ) {\n\t\t\t\t\t\t\t\tif ( isReferenceWidget ) {\n\t\t\t\t\t\t\t\t\tif ( this.containerRef.current ) {\n\t\t\t\t\t\t\t\t\t\twindow.wpWidgets.save(\n\t\t\t\t\t\t\t\t\t\t\twindow.jQuery(\n\t\t\t\t\t\t\t\t\t\t\t\tthis.containerRef.current\n\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tthis.props.onInstanceChange(\n\t\t\t\t\t\t\t\t\tthis.retrieveUpdatedInstance()\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} }\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tref={ this.widgetContentRef }\n\t\t\t\t\t\t\tclassName=\"widget-content\"\n\t\t\t\t\t\t\tdangerouslySetInnerHTML={ { __html: form } }\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{ isReferenceWidget && (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"widget-id\"\n\t\t\t\t\t\t\t\t\tclassName=\"widget-id\"\n\t\t\t\t\t\t\t\t\tvalue={ id }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tref={ this.idBaseInputRef }\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"id_base\"\n\t\t\t\t\t\t\t\t\tclassName=\"id_base\"\n\t\t\t\t\t\t\t\t\tvalue={ idBase }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\tref={ this.widgetNumberInputRef }\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"widget_number\"\n\t\t\t\t\t\t\t\t\tclassName=\"widget_number\"\n\t\t\t\t\t\t\t\t\tvalue={ number }\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"multi_number\"\n\t\t\t\t\t\t\t\t\tclassName=\"multi_number\"\n\t\t\t\t\t\t\t\t\tvalue=\"\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\t\ttype=\"hidden\"\n\t\t\t\t\t\t\t\t\tname=\"add_new\"\n\t\t\t\t\t\t\t\t\tclassName=\"add_new\"\n\t\t\t\t\t\t\t\t\tvalue=\"\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t) }\n\t\t\t\t\t</form>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tshouldTriggerInstanceUpdate() {\n\t\tif ( ! this.formRef.current ) {\n\t\t\treturn false;\n\t\t}\n\t\tif ( ! this.previousFormData ) {\n\t\t\treturn true;\n\t\t}\n\t\tconst currentFormData = new window.FormData( this.formRef.current );\n\t\tconst currentFormDataKeys = Array.from( currentFormData.keys() );\n\t\tconst previousFormDataKeys = Array.from( this.previousFormData.keys() );\n\t\tif ( currentFormDataKeys.length !== previousFormDataKeys.length ) {\n\t\t\treturn true;\n\t\t}\n\t\tfor ( const rawKey of currentFormDataKeys ) {\n\t\t\tif (\n\t\t\t\t! isShallowEqual(\n\t\t\t\t\tcurrentFormData.getAll( rawKey ),\n\t\t\t\t\tthis.previousFormData.getAll( rawKey )\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tthis.previousFormData = currentFormData;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\ttriggerWidgetEvent( event ) {\n\t\twindow\n\t\t\t.jQuery( window.document )\n\t\t\t.trigger( event, [ window.jQuery( this.containerRef.current ) ] );\n\t}\n\n\tretrieveUpdatedInstance() {\n\t\tif ( this.formRef.current ) {\n\t\t\tconst form = this.formRef.current;\n\t\t\tconst formData = new window.FormData( form );\n\t\t\tconst updatedInstance = {};\n\t\t\tfor ( const rawKey of formData.keys() ) {\n\t\t\t\t// This fields are added to the form because the widget JavaScript code may use this values.\n\t\t\t\t// They are not relevant for the update mechanism.\n\t\t\t\tif (\n\t\t\t\t\tincludes(\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t'widget-id',\n\t\t\t\t\t\t\t'id_base',\n\t\t\t\t\t\t\t'widget_number',\n\t\t\t\t\t\t\t'multi_number',\n\t\t\t\t\t\t\t'add_new',\n\t\t\t\t\t\t],\n\t\t\t\t\t\trawKey\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tconst matches = rawKey.match( /[^\\[]*\\[[-\\d]*\\]\\[([^\\]]*)\\]/ );\n\t\t\t\tconst keyParsed =\n\t\t\t\t\tmatches && matches[ 1 ] ? matches[ 1 ] : rawKey;\n\t\t\t\tconst value = formData.getAll( rawKey );\n\t\t\t\tif ( value.length > 1 ) {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value;\n\t\t\t\t} else {\n\t\t\t\t\tupdatedInstance[ keyParsed ] = value[ 0 ];\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn updatedInstance;\n\t\t}\n\t}\n}\n\nexport default LegacyWidgetEditDomManager;\n"]}